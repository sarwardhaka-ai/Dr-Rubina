name: IndexNow â€“ Submit Changed + Targeted URLs

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  indexnow:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install node-fetch@2

      - name: Submit URLs to IndexNow
        env:
          INDEXNOW_KEY: ${{ secrets.INDEXNOW_KEY }}
        run: |
          node << 'EOF'
          const fetch = require('node-fetch');
          const { execSync } = require('child_process');

          const DOMAIN = 'https://drrubinasultana.com';
          const key = process.env.INDEXNOW_KEY;

          if (!key) {
            console.error('âŒ INDEXNOW_KEY is missing');
            process.exit(1);
          }

          // 1ï¸âƒ£ Target URLs (ONLY pages you still want Bing to focus on)
          const priorityUrls = [
            `${DOMAIN}/best-cervical-cancer-specialist-dhaka`,
            `${DOMAIN}/bn/best-tumor-specialist-dhaka`,
            `${DOMAIN}/bn/best-lung-cancer-specialist-dhaka`
          ];

          // 2ï¸âƒ£ Detect changed HTML files from last commit
          let changedUrls = [];
          try {
            const diff = execSync('git diff --name-only HEAD~1 HEAD', { encoding: 'utf8' })
              .split('\n')
              .filter(Boolean);

            changedUrls = diff
              .filter(f => f.endsWith('.html'))
              .map(file => {
                if (file === 'index.html') return `${DOMAIN}/`;
                if (file === 'bn.html') return `${DOMAIN}/bn`;
                return `${DOMAIN}/${file.replace(/\.html$/, '')}`;
              });
          } catch (e) {}

          // 3ï¸âƒ£ Merge + deduplicate
          const urls = [...new Set([...priorityUrls, ...changedUrls])];

          if (urls.length === 0) {
            console.log('â„¹ï¸ No URLs to submit');
            process.exit(0);
          }

          console.log('ðŸš€ Submitting URLs to IndexNow:');
          urls.forEach(u => console.log(' -', u));

          async function submit(url) {
            const endpoint =
              `https://api.indexnow.org/indexnow?url=${encodeURIComponent(url)}&key=${key}`;
            const res = await fetch(endpoint);
            console.log(`âœ” ${url} â†’ ${res.status}`);
          }

          (async () => {
            for (const url of urls) {
              await submit(url);
            }
          })();
          EOF
